<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Seasonal Sales Forecasting</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
      .dashboard-welcome {
        background: linear-gradient(135deg, var(--primary), var(--accent));
        color: white;
        padding: 3rem 2.5rem;
        border-radius: 16px;
        margin-bottom: 2.5rem;
        box-shadow: var(--shadow-lg);
      }

      .dashboard-welcome h1 {
        font-size: 2.4rem;
        margin-bottom: 0.5rem;
        font-weight: 800;
      }

      .dashboard-welcome p {
        font-size: 1.15rem;
        opacity: 0.95;
        margin: 0;
      }

      .action-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.5rem;
        margin: 2rem 0 3rem 0;
      }

      .action-btn {
        background: white;
        border: none;
        padding: 2.5rem 2rem;
        border-radius: 16px;
        box-shadow: var(--shadow-md);
        cursor: pointer;
        transition: var(--transition);
        text-decoration: none;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        font-size: 1rem;
        font-weight: 700;
        color: var(--secondary);
        border-top: 4px solid transparent;
      }

      .action-btn:hover {
        transform: translateY(-8px);
        box-shadow: var(--shadow-lg);
      }

      .action-btn.upload {
        border-top-color: var(--success);
        background: linear-gradient(to bottom, rgba(16, 185, 129, 0.05), white);
      }

      .action-btn.upload:hover {
        background: linear-gradient(135deg, var(--success), #059669);
        color: white;
      }

      .action-btn.analyze {
        border-top-color: var(--info);
        background: linear-gradient(to bottom, rgba(59, 130, 246, 0.05), white);
      }

      .action-btn.analyze:hover {
        background: linear-gradient(135deg, var(--info), #2563eb);
        color: white;
      }

      .action-btn.forecast {
        border-top-color: var(--warning);
        background: linear-gradient(to bottom, rgba(245, 158, 11, 0.05), white);
      }

      .action-btn.forecast:hover {
        background: linear-gradient(135deg, var(--warning), #d97706);
        color: white;
      }

      .action-btn.recommendations {
        border-top-color: var(--danger);
        background: linear-gradient(to bottom, rgba(239, 68, 68, 0.05), white);
      }

      .action-btn.recommendations:hover {
        background: linear-gradient(135deg, var(--danger), #dc2626);
        color: white;
      }

      .action-btn .icon {
        font-size: 3rem;
        display: block;
      }

      .action-btn .label {
        font-size: 1.1rem;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: linear-gradient(135deg, var(--primary-light), white);
        padding: 2rem;
        border-radius: 12px;
        border-left: 4px solid var(--primary);
        transition: var(--transition);
      }

      .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
      }

      .stat-card h3 {
        color: var(--gray-600);
        font-size: 0.95rem;
        margin: 0 0 0.75rem 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
      }

      .stat-card .value {
        font-size: 2rem;
        font-weight: 800;
        color: var(--primary);
      }

      .charts-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 1.5rem;
        margin: 2rem 0;
      }

      .chart-container {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: var(--shadow-md);
        transition: var(--transition);
      }

      .chart-container:hover {
        box-shadow: var(--shadow-lg);
      }

      .chart-container h3 {
        margin-top: 0;
        color: var(--secondary);
        font-size: 1.2rem;
        margin-bottom: 1.5rem;
      }

      .chart-wrapper {
        position: relative;
        height: 300px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }

      table thead {
        background: linear-gradient(135deg, var(--primary-light), #f0f4ff);
      }

      table th {
        padding: 1rem;
        text-align: left;
        font-weight: 700;
        color: var(--primary);
        border-bottom: 2px solid var(--primary);
      }

      table td {
        padding: 0.9rem 1rem;
        border-bottom: 1px solid var(--gray-200);
      }

      table tbody tr:hover {
        background-color: var(--gray-50);
      }

      .store-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1.5rem;
      }

      .store-item {
        background: linear-gradient(135deg, var(--primary-light), white);
        padding: 1.5rem;
        border-radius: 12px;
        border-left: 4px solid var(--primary);
      }

      .store-item strong {
        color: var(--primary);
        font-size: 1.1rem;
      }

      .store-item .sales-value {
        color: var(--secondary);
        font-weight: 700;
        margin-top: 0.5rem;
      }

      .charts-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 2rem;
        margin-bottom: 2.5rem;
      }

      .chart-container {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--gray-200);
        transition: var(--transition);
      }

      .chart-container:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-4px);
      }

      .chart-container.full-width {
        grid-column: 1 / -1;
      }

      .chart-container h3 {
        font-size: 1.3rem;
        color: var(--secondary);
        margin-bottom: 1.5rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.65rem;
      }

      .chart-wrapper {
        position: relative;
        height: 350px;
        margin-bottom: 1rem;
      }

      .chart-container.full-width .chart-wrapper {
        height: 400px;
      }

      .chart-info {
        font-size: 0.85rem;
        color: var(--gray-500);
        padding: 0.75rem;
        background: var(--gray-50);
        border-left: 3px solid var(--primary);
        border-radius: 6px;
        margin-top: 1rem;
      }

      @media (max-width: 1024px) {
        .charts-section {
          grid-template-columns: 1fr;
          gap: 1.5rem;
        }

        .chart-container.full-width {
          grid-column: 1;
        }
      }

      @media (max-width: 768px) {
        .chart-wrapper {
          height: 300px;
        }

        .chart-container {
          padding: 1.5rem;
        }

        .chart-container h3 {
          font-size: 1.1rem;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>üìä Seasonal Sales Forecasting</h1>
      <ul class="nav-links">
        <li><a href="/upload">Upload</a></li>
        <li><a href="/analysis">Analysis</a></li>
        <li><a href="/forecast">Forecast</a></li>
        <li><a href="/recommendation">Recommendations</a></li>
        <li><a href="/logout">Logout</a></li>
      </ul>
    </header>

    <div class="container">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <ul class="flashes">
          {% for category, message in messages %}
            <li class="{{ category }}">{{ message }}</li>
          {% endfor %}
          </ul>
        {% endif %}
      {% endwith %}

      <div class="dashboard-welcome">
        <h1>Welcome, {{ session.username }}! üëã</h1>
        <p>Your Supermarket Sales Intelligence Dashboard</p>
      </div>

      <div class="action-buttons">
        <a href="/upload" class="action-btn upload">
          <div class="icon">üì§</div>
          <div class="label">Upload Data</div>
        </a>
        <a href="/analysis" class="action-btn analyze">
          <div class="icon">üìà</div>
          <div class="label">Analyze Sales</div>
        </a>
        <a href="/forecast" class="action-btn forecast">
          <div class="icon">üîÆ</div>
          <div class="label">Forecast Sales</div>
        </a>
        <a href="/recommendation" class="action-btn recommendations">
          <div class="icon">üí°</div>
          <div class="label">View Recommendations</div>
        </a>
      </div>

      {% if stats %}
      <div class="card">
        <h2>üìä Key Statistics</h2>
        <div class="dashboard-grid">
          <div class="stat-card">
            <h3>Total Stores</h3>
            <div class="value">{{ stats.total_stores }}</div>
          </div>
          <div class="stat-card">
            <h3>Total Records</h3>
            <div class="value">{{ "{:,}".format(stats.total_records) }}</div>
          </div>
          <div class="stat-card">
            <h3>Avg Weekly Sales</h3>
            <div class="value">${{ "{:,.0f}".format(stats.avg_sales) }}</div>
          </div>
          <div class="stat-card">
            <h3>Max Weekly Sales</h3>
            <div class="value">${{ "{:,.0f}".format(stats.max_sales) }}</div>
          </div>
        </div>
      </div>

      {% if stores %}
      <div class="charts-section">
        <div class="chart-container">
          <h3>üìä Top 10 Stores by Average Sales</h3>
          <div class="chart-wrapper">
            <canvas id="storesChart"></canvas>
          </div>
        </div>
        <div class="chart-container">
          <h3>üìà Sales Distribution</h3>
          <div class="chart-wrapper">
            <canvas id="distributionChart"></canvas>
          </div>
        </div>
      </div>

      <div class="charts-section">
        <div class="chart-container">
          <h3>üìä Sales Range Histogram</h3>
          <div class="chart-wrapper">
            <canvas id="histogramChart"></canvas>
          </div>
        </div>
        <div class="chart-container">
          <h3>üí∞ Store Performance Comparison</h3>
          <div class="chart-wrapper">
            <canvas id="performanceChart"></canvas>
          </div>
        </div>
      </div>

      <div class="charts-section">
        <div class="chart-container full-width">
          <h3>üìà Top 5 Stores Sales Volatility Analysis</h3>
          <div class="chart-wrapper">
            <canvas id="volatilityChart"></canvas>
          </div>
        </div>
      </div>
      {% endif %}

      <div class="card">
        <h2>üìã Dataset Information</h2>
        <table>
          <tr>
            <td><strong>Data Source:</strong></td>
            <td>{{ stats.data_source }}</td>
          </tr>
          <tr>
            <td><strong>Date Range:</strong></td>
            <td>{{ stats.date_range }}</td>
          </tr>
          <tr>
            <td><strong>Total Weeks:</strong></td>
            <td>{{ stats.total_weeks }}</td>
          </tr>
          <tr>
            <td><strong>Minimum Weekly Sales:</strong></td>
            <td>${{ "{:,.0f}".format(stats.min_sales) }}</td>
          </tr>
          <tr>
            <td><strong>Standard Deviation:</strong></td>
            <td>${{ "{:,.0f}".format(stats.std_sales) }}</td>
          </tr>
          <tr>
            <td><strong>Records Processed:</strong></td>
            <td>{{ "{:,}".format(stats.total_records) }}</td>
          </tr>
        </table>
      </div>

      {% if preprocessing_stats %}
      <div class="card">
        <h2>üîß Data Preprocessing Summary</h2>
        <table>
          <tr>
            <td><strong>Records After Preprocessing:</strong></td>
            <td>{{ "{:,}".format(preprocessing_stats.records_after_preprocessing|default(0)) }}</td>
          </tr>
          <tr>
            <td><strong>Missing Values Remaining:</strong></td>
            <td>{{ preprocessing_stats.missing_values_remaining|default(0) }}</td>
          </tr>
          <tr>
            <td><strong>Duplicates Removed:</strong></td>
            <td>{{ preprocessing_stats.duplicates_removed|default(0) }}</td>
          </tr>
          <tr>
            <td><strong>Data Quality Status:</strong></td>
            <td>{{ preprocessing_stats.data_quality_status|default('Unknown') }}</td>
          </tr>
          <tr>
            <td><strong>Temporal Features Extracted:</strong></td>
            <td>{{ preprocessing_stats.temporal_features_extracted|default(0) }}</td>
          </tr>
        </table>
      </div>
      {% endif %}

      <div class="card">
        <h2>üíæ Data Storage Status</h2>
        <table>
          <tr>
            <td><strong>Status:</strong></td>
            <td><span style="color: var(--success); font-weight: bold;">‚úÖ Data Stored in Database</span></td>
          </tr>
          <tr>
            <td><strong>Access Level:</strong></td>
            <td>Private (User-specific data)</td>
          </tr>
          <tr>
            <td><strong>Database Location:</strong></td>
            <td>SQLite (database/sales.db)</td>
          </tr>
          <tr>
            <td><strong>Last Updated:</strong></td>
            <td id="last_update">Loading...</td>
          </tr>
        </table>
      </div>

      {% if stores %}
      <div class="card">
        <h2>üè™ Top 10 Store Performance</h2>
        <table>
          <thead>
            <tr>
              <th>Store ID</th>
              <th>Avg Sales</th>
              <th>Min Sales</th>
              <th>Max Sales</th>
              <th>Std Dev</th>
            </tr>
          </thead>
          <tbody>
            {% for store in stores[:10] %}
            <tr>
              <td><strong>{{ store.Store }}</strong></td>
              <td>${{ "{:,.0f}".format(store.Avg_Sales) }}</td>
              <td>${{ "{:,.0f}".format(store.Min_Sales) }}</td>
              <td>${{ "{:,.0f}".format(store.Max_Sales) }}</td>
              <td>${{ "{:,.0f}".format(store.Std_Sales) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <p style="margin-top: 1rem; color: var(--gray-600);"><em>üìç Showing first 10 stores. Visit <strong>Analyze Sales</strong> for detailed insights on all stores.</em></p>
      </div>
      {% endif %}
      {% else %}
      <div class="card" style="background: var(--warning); background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(249, 115, 22, 0.05)); border-left: 4px solid var(--warning);">
        <h2>‚ö†Ô∏è Dataset Not Available</h2>
        <p>The dataset could not be loaded. Please ensure the Walmart-dataset.csv file exists in the data folder, or <a href="/upload">upload your data here</a>.</p>
      </div>
      {% endif %}
    </div>
    <footer>
      <p>&copy; 2026 <strong>Seasonal Sales Forecasting System</strong> - Powered by Advanced ARIMA Analytics | All Rights Reserved</p>
    </footer>
  </body>
  <script>
    // Fetch and display user data storage summary
    fetch('/api/user-data-summary')
      .then(response => response.json())
      .then(data => {
        const lastUpdateEl = document.getElementById('last_update');
        if (lastUpdateEl && data.records_stored > 0) {
          const now = new Date();
          lastUpdateEl.textContent = now.toLocaleString();
        }
      })
      .catch(error => console.log('Data storage summary not available'));

    // Initialize charts with data
    document.addEventListener('DOMContentLoaded', function() {
      const stores = {{ stores|tojson if stores else '[]' }};
      
      if (stores && stores.length > 0) {
        // ===== CHART 1: Top 10 Stores Bar Chart =====
        const topStores = stores.slice(0, 10);
        const storeLabels = topStores.map(s => `Store #${s.Store}`);
        const storeAvg = topStores.map(s => s.Avg_Sales);
        
        const storesCtx = document.getElementById('storesChart');
        if (storesCtx) {
          new Chart(storesCtx, {
            type: 'bar',
            data: {
              labels: storeLabels,
              datasets: [{
                label: 'Average Weekly Sales ($)',
                data: storeAvg,
                backgroundColor: [
                  'rgba(59, 130, 246, 0.85)',
                  'rgba(37, 99, 235, 0.85)',
                  'rgba(29, 78, 216, 0.85)',
                  'rgba(37, 99, 235, 0.80)',
                  'rgba(59, 130, 246, 0.75)',
                  'rgba(59, 130, 246, 0.70)',
                  'rgba(96, 165, 250, 0.85)',
                  'rgba(147, 197, 253, 0.85)',
                  'rgba(96, 165, 250, 0.80)',
                  'rgba(191, 219, 254, 0.90)'
                ],
                borderColor: [
                  'rgba(30, 64, 175, 1)',
                  'rgba(30, 64, 175, 1)',
                  'rgba(29, 57, 128, 1)',
                  'rgba(30, 64, 175, 1)',
                  'rgba(37, 99, 235, 1)',
                  'rgba(37, 99, 235, 1)',
                  'rgba(59, 130, 246, 1)',
                  'rgba(96, 165, 250, 1)',
                  'rgba(59, 130, 246, 1)',
                  'rgba(147, 197, 253, 1)'
                ],
                borderWidth: 2,
                borderRadius: 8,
                shadow: {
                  offsetX: 2,
                  offsetY: 2,
                  blur: 4,
                  color: 'rgba(0, 0, 0, 0.1)'
                }
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { 
                  display: true, 
                  labels: { 
                    font: { size: 12, weight: 'bold' },
                    padding: 15,
                    usePointStyle: true
                  }
                },
                tooltip: {
                  backgroundColor: 'rgba(0, 0, 0, 0.8)',
                  titleFont: { size: 13, weight: 'bold' },
                  bodyFont: { size: 12 },
                  padding: 12,
                  cornerRadius: 8,
                  displayColors: true
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { 
                    callback: function(value) { return '$' + value.toLocaleString(); },
                    font: { size: 11 }
                  },
                  grid: {
                    color: 'rgba(0, 0, 0, 0.05)',
                    drawBorder: false
                  }
                },
                x: {
                  grid: { display: false }
                }
              }
            }
          });
        }

        // ===== CHART 2: Sales Distribution Doughnut Chart =====
        const allSales = stores.flatMap(s => [s.Min_Sales, s.Avg_Sales, s.Max_Sales]);
        const bins = [
          allSales.filter(v => v < 5000).length,
          allSales.filter(v => v >= 5000 && v < 10000).length,
          allSales.filter(v => v >= 10000 && v < 15000).length,
          allSales.filter(v => v >= 15000 && v < 20000).length,
          allSales.filter(v => v >= 20000).length
        ];

        const distCtx = document.getElementById('distributionChart');
        if (distCtx) {
          new Chart(distCtx, {
            type: 'doughnut',
            data: {
              labels: ['<$5K', '$5K-$10K', '$10K-$15K', '$15K-$20K', '>$20K'],
              datasets: [{
                data: bins,
                backgroundColor: [
                  'rgba(59, 130, 246, 0.85)',
                  'rgba(37, 99, 235, 0.85)',
                  'rgba(16, 185, 129, 0.85)',
                  'rgba(245, 158, 11, 0.85)',
                  'rgba(239, 68, 68, 0.85)'
                ],
                borderColor: [
                  'rgba(30, 64, 175, 1)',
                  'rgba(30, 64, 175, 1)',
                  'rgba(5, 150, 105, 1)',
                  'rgba(217, 119, 6, 1)',
                  'rgba(220, 38, 38, 1)'
                ],
                borderWidth: 3,
                hoverOffset: 12
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { 
                  position: 'bottom',
                  labels: { 
                    font: { size: 11, weight: '500' },
                    padding: 15,
                    usePointStyle: true,
                    pointStyle: 'circle'
                  }
                },
                tooltip: {
                  backgroundColor: 'rgba(0, 0, 0, 0.8)',
                  titleFont: { size: 13, weight: 'bold' },
                  bodyFont: { size: 12 },
                  padding: 12,
                  cornerRadius: 8,
                  callbacks: {
                    label: function(context) {
                      const label = context.label || '';
                      const value = context.parsed || 0;
                      const total = context.dataset.data.reduce((a, b) => a + b, 0);
                      const percentage = ((value / total) * 100).toFixed(1);
                      return `${label}: ${value} records (${percentage}%)`;
                    }
                  }
                }
              }
            }
          });
        }

        // ===== CHART 3: Sales Range Histogram =====
        const histogramCtx = document.getElementById('histogramChart');
        if (histogramCtx) {
          const binSize = 2000;
          const minSale = Math.min(...allSales);
          const maxSale = Math.max(...allSales);
          const histBins = {};
          
          for (let i = Math.floor(minSale / binSize); i <= Math.ceil(maxSale / binSize); i++) {
            const rangeStart = i * binSize;
            const rangeEnd = (i + 1) * binSize;
            const label = `$${(i * binSize / 1000).toFixed(0)}K-$${((i + 1) * binSize / 1000).toFixed(0)}K`;
            histBins[label] = allSales.filter(v => v >= rangeStart && v < rangeEnd).length;
          }
          
          new Chart(histogramCtx, {
            type: 'bar',
            data: {
              labels: Object.keys(histBins),
              datasets: [{
                label: 'Frequency',
                data: Object.values(histBins),
                backgroundColor: 'rgba(16, 185, 129, 0.8)',
                borderColor: 'rgba(5, 150, 105, 1)',
                borderWidth: 2,
                borderRadius: 6,
                hoverBackgroundColor: 'rgba(10, 150, 100, 1)'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              indexAxis: 'x',
              plugins: {
                legend: { display: true, labels: { font: { size: 12, weight: 'bold' } } },
                tooltip: {
                  backgroundColor: 'rgba(0, 0, 0, 0.8)',
                  padding: 10,
                  cornerRadius: 8
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { font: { size: 11 } },
                  grid: { color: 'rgba(0, 0, 0, 0.05)' }
                },
                x: {
                  grid: { display: false }
                }
              }
            }
          });
        }

        // ===== CHART 4: Store Performance Comparison (Min vs Max) =====
        const top5Stores = stores.slice(0, 5);
        const perfLabels = top5Stores.map(s => `Store #${s.Store}`);
        
        const perfCtx = document.getElementById('performanceChart');
        if (perfCtx) {
          new Chart(perfCtx, {
            type: 'radar',
            data: {
              labels: perfLabels,
              datasets: [
                {
                  label: 'Min Sales',
                  data: top5Stores.map(s => s.Min_Sales),
                  borderColor: 'rgba(239, 68, 68, 0.8)',
                  backgroundColor: 'rgba(239, 68, 68, 0.2)',
                  pointBackgroundColor: 'rgba(239, 68, 68, 1)',
                  borderWidth: 2,
                  tension: 0.4
                },
                {
                  label: 'Avg Sales',
                  data: top5Stores.map(s => s.Avg_Sales),
                  borderColor: 'rgba(37, 99, 235, 0.8)',
                  backgroundColor: 'rgba(37, 99, 235, 0.2)',
                  pointBackgroundColor: 'rgba(37, 99, 235, 1)',
                  borderWidth: 2,
                  tension: 0.4
                },
                {
                  label: 'Max Sales',
                  data: top5Stores.map(s => s.Max_Sales),
                  borderColor: 'rgba(16, 185, 129, 0.8)',
                  backgroundColor: 'rgba(16, 185, 129, 0.2)',
                  pointBackgroundColor: 'rgba(16, 185, 129, 1)',
                  borderWidth: 2,
                  tension: 0.4
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: { font: { size: 11, weight: '500' }, padding: 15 }
                },
                tooltip: {
                  backgroundColor: 'rgba(0, 0, 0, 0.8)',
                  padding: 10,
                  cornerRadius: 8
                }
              },
              scales: {
                r: {
                  ticks: { 
                    font: { size: 10 },
                    callback: function(value) { return '$' + (value / 1000).toFixed(0) + 'K'; }
                  },
                  grid: { color: 'rgba(0, 0, 0, 0.08)' }
                }
              }
            }
          });
        }

        // ===== CHART 5: Sales Volatility Analysis (Top 5 Stores) =====
        const volatilityCtx = document.getElementById('volatilityChart');
        if (volatilityCtx) {
          const volatilityData = top5Stores.map(s => ({
            store: `Store #${s.Store}`,
            volatility: s.Std_Sales,
            range: s.Max_Sales - s.Min_Sales
          }));
          
          new Chart(volatilityCtx, {
            type: 'scatter',
            data: {
              datasets: [{
                label: 'Sales Volatility (Standard Deviation)',
                data: volatilityData.map((d, idx) => ({
                  x: idx,
                  y: d.volatility,
                  r: d.range / 500
                })),
                borderColor: 'rgba(245, 158, 11, 1)',
                backgroundColor: [
                  'rgba(245, 158, 11, 0.7)',
                  'rgba(249, 115, 22, 0.7)',
                  'rgba(239, 68, 68, 0.7)',
                  'rgba(229, 57, 53, 0.7)',
                  'rgba(211, 47, 47, 0.7)'
                ],
                borderWidth: 2,
                hoverBorderWidth: 3
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  labels: { font: { size: 12, weight: 'bold' }, padding: 15 }
                },
                tooltip: {
                  backgroundColor: 'rgba(0, 0, 0, 0.8)',
                  padding: 10,
                  cornerRadius: 8,
                  callbacks: {
                    label: function(context) {
                      const idx = context.dataIndex;
                      return volatilityData[idx].store + ': $' + volatilityData[idx].volatility.toLocaleString();
                    }
                  }
                }
              },
              scales: {
                x: {
                  ticks: {
                    callback: function(value) {
                      return volatilityData[value] ? volatilityData[value].store : '';
                    },
                    font: { size: 11 }
                  },
                  grid: { display: false }
                },
                y: {
                  title: {
                    display: true,
                    text: 'Std Deviation ($)'
                  },
                  ticks: {
                    callback: function(value) { return '$' + value.toLocaleString(); },
                    font: { size: 11 }
                  },
                  grid: { color: 'rgba(0, 0, 0, 0.05)' }
                }
              }
            }
          });
        }
      }
    });
  </script>
</html>
